{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"workspaceName": {
			"type": "string",
			"metadata": "Workspace name",
			"defaultValue": "synw-upds-kuaf-dev-i40"
		}
	},
	"variables": {
		"workspaceId": "[concat('Microsoft.Synapse/workspaces/', parameters('workspaceName'))]"
	},
	"resources": [
		{
			"name": "[concat(parameters('workspaceName'), '/CopiaBusiness')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"content": {
					"query": " CREATE DATABASE updatalakehouse_business;\nGO\n\nUSE updatalakehouse_business;\nGO\n\n-----------------------------------------------\n--Paso 2: Creacion de dataset por zona de datos\n-----------------------------------------------\nCREATE SCHEMA master_transaction AUTHORIZATION dbo;\nGO\n\nCREATE SCHEMA master_channel AUTHORIZATION dbo;\nGO\n\nCREATE SCHEMA master_party AUTHORIZATION dbo;\nGO\n\nCREATE SCHEMA business_knowa AUTHORIZATION dbo;\nGO\n\n-------------------------------------------------------------------------\n--Paso 3: Asignación de clave de encriptación y formato de tablas externas\n-------------------------------------------------------------------------\nCREATE MASTER KEY ENCRYPTION BY PASSWORD = 'p39248J#asdasdiu89yuj1k29sdd'\nGO\n\nCREATE DATABASE SCOPED CREDENTIAL UPUserIdentity WITH IDENTITY = 'SHARED ACCESS SIGNATURE',\nSECRET = '?sv=2021-12-02&ss=bfqt&srt=sco&sp=rwdlacupyx&se=2023-06-30T10:47:11Z&st=2023-04-30T02:47:11Z&spr=https&sig=ezJCBxXXS9BCWwv3OA4CRL7y7BVfumdfdnE0VrqPlGE%3D'\nGO\n\nCREATE EXTERNAL DATA SOURCE ExternalUPDataSource\nWITH (\n    LOCATION = 'https://dlsupdskuafdevi5l.dfs.core.windows.net/',\n    CREDENTIAL = UPUserIdentity\n);\nGO\n\nCREATE EXTERNAL FILE FORMAT UPParquetFileFormat \nWITH (\n    FORMAT_TYPE = PARQUET,\n    DATA_COMPRESSION = 'org.apache.hadoop.io.compress.SnappyCodec'\n);\nGO\n\n-------------------------------------------------------------------------\n--Paso 4: Copia de Master a Business\n-------------------------------------------------------------------------\n\n-------------------------------------------------------------------------\n-- Carpeta Badges\n-----------------------------------------------\n--Paso 01\n-----------------------------------------------\nSELECT TOP (10) *\nFrom OPENROWSET (BULK '/master/data/m_sharedknow/m_badges/m_badges-00001.parquet',\nDATA_SOURCE= 'ExternalUPDataSource',\nFORMAT ='PARQUET')  AS [file]\nGO;\n-----------------------------------------------\n--Paso 02\n-----------------------------------------------\nCREATE EXTERNAL TABLE master_transaction.dim_business_badges3(\n    Id int,\n    Name nvarchar(50),\n    UserId int,\n    Date DATE\n)\n WITH (\n     LOCATION = '/master/data/m_sharedknow/m_badges/m_badges-00001.parquet',\n     DATA_SOURCE = ExternalUPDataSource,  \n     FILE_FORMAT = UPParquetFileFormat\n )\nGO\n-----------------------------------------------\n--Paso 03 -- Validación\n-----------------------------------------------\nSELECT TOP(100) * FROM master_transaction.dim_business_badges3\n-----------------------------------------------\n--Paso 04\n-----------------------------------------------\nCREATE EXTERNAL TABLE business_knowa.bi_badges3\nWITH (\n    LOCATION = '/business/b_sharedknow/b_badges/',\n    DATA_SOURCE = ExternalUPDataSource,  \n    FILE_FORMAT = UPParquetFileFormat\n) AS \nSELECT * FROM master_transaction.dim_business_badges3;\n\nSELECT * FROM business_knowa.bi_badges3;\n\n-------------------------------------------------------------------------\n-- Carpeta Comments\n-----------------------------------------------\n--Paso 01\n-----------------------------------------------\nSELECT TOP (10) *\nFrom OPENROWSET (BULK '/master/data/m_sharedknow/m_comments/m_comments-00002.parquet',\nDATA_SOURCE= 'ExternalUPDataSource',\nFORMAT ='PARQUET')  AS [file]\nGO;\n-----------------------------------------------\n--Paso 02\n-----------------------------------------------\nCREATE EXTERNAL TABLE master_transaction.dim_business_comments2(\n    Id int,\n    CreationDate DATE,\n    PostId int,\n    Score int,\n    UserId int\n)\n WITH (\n     LOCATION = '/master/data/m_sharedknow/m_comments/m_comments-00002.parquet',\n     DATA_SOURCE = ExternalUPDataSource,  \n     FILE_FORMAT = UPParquetFileFormat\n )\nGO\n-----------------------------------------------\n--Paso 03 -- Validación\n-----------------------------------------------\nSELECT TOP(100) * FROM master_transaction.dim_business_comments2\n-----------------------------------------------\n--Paso 04\n-----------------------------------------------\nCREATE EXTERNAL TABLE business_knowa.bi_comments2\nWITH (\n    LOCATION = '/business/b_sharedknow/b_comments/',\n    DATA_SOURCE = ExternalUPDataSource,  \n    FILE_FORMAT = UPParquetFileFormat\n) AS \nSELECT * FROM master_transaction.dim_business_comments2;\n\nSELECT * FROM business_knowa.bi_comments2;\n\n-------------------------------------------------------------------------\n-- Carpeta Linkypes\n-----------------------------------------------\n--Paso 01\n-----------------------------------------------\nSELECT TOP (10) *\nFrom OPENROWSET (BULK '/master/data/m_sharedknow/m_linktypes/m_linktypes-00001.parquet',\nDATA_SOURCE= 'ExternalUPDataSource',\nFORMAT ='PARQUET')  AS [file]\nGO;\n-----------------------------------------------\n--Paso 02\n-----------------------------------------------\nCREATE EXTERNAL TABLE master_transaction.dim_business_linktypes(\n    Id int,\n    Type nvarchar(20)\n)\n WITH (\n     LOCATION = '/master/data/m_sharedknow/m_linktypes/m_linktypes-00001.parquet',\n     DATA_SOURCE = ExternalUPDataSource,  \n     FILE_FORMAT = UPParquetFileFormat\n )\nGO\n-----------------------------------------------\n--Paso 03 -- Validación\n-----------------------------------------------\nSELECT TOP(100) * FROM master_transaction.dim_business_linktypes\n-----------------------------------------------\n--Paso 04\n-----------------------------------------------\nCREATE EXTERNAL TABLE business_knowa.bi_linktypes\nWITH (\n    LOCATION = '/business/b_sharedknow/b_linktypes/',\n    DATA_SOURCE = ExternalUPDataSource,  \n    FILE_FORMAT = UPParquetFileFormat\n) AS \nSELECT * FROM master_transaction.dim_business_linktypes;\n\nSELECT * FROM business_knowa.bi_linktypes;\n\n-------------------------------------------------------------------------\n-- Carpeta Postlinks\n-----------------------------------------------\n--Paso 01\n-----------------------------------------------\nSELECT TOP (10) *\nFrom OPENROWSET (BULK '/master/data/m_sharedknow/m_postlinks/m_postlinks-00002.parquet',\nDATA_SOURCE= 'ExternalUPDataSource',\nFORMAT ='PARQUET')  AS [file]\nGO;\n-----------------------------------------------\n--Paso 02\n-----------------------------------------------\nCREATE EXTERNAL TABLE master_transaction.dim_business_postlinks(\n    Id int,\n    CreationDate DATE,\n    PostId int,\n    RelatedPostId int,\n    LinkTypeId int\n)\n WITH (\n     LOCATION = '/master/data/m_sharedknow/m_postlinks/m_postlinks-00002.parquet',\n     DATA_SOURCE = ExternalUPDataSource,  \n     FILE_FORMAT = UPParquetFileFormat\n )\nGO\n-----------------------------------------------\n--Paso 03 -- Validación\n-----------------------------------------------\nSELECT TOP(100) * FROM master_transaction.dim_business_postlinks\n-----------------------------------------------\n--Paso 04\n-----------------------------------------------\nCREATE EXTERNAL TABLE business_knowa.bi_postlinks\nWITH (\n    LOCATION = '/business/b_sharedknow/b_postlinks',\n    DATA_SOURCE = ExternalUPDataSource,  \n    FILE_FORMAT = UPParquetFileFormat\n) AS \nSELECT * FROM master_transaction.dim_business_postlinks;\n\nSELECT * FROM business_knowa.bi_postlinks;\n\n-------------------------------------------------------------------------\n-- Carpeta Posts1\n-----------------------------------------------\n--Paso 01\n-----------------------------------------------\nSELECT TOP (10) *\nFrom OPENROWSET (BULK '/master/data/m_sharedknow/m_posts/m_2008-01-01/m_posts_200801-00002.parquet',\nDATA_SOURCE= 'ExternalUPDataSource',\nFORMAT ='PARQUET')  AS [file]\nGO;\n-----------------------------------------------\n--Paso 02\n-----------------------------------------------\nCREATE EXTERNAL TABLE master_transaction.dim_business_posts1_3(\n    Id int,\n    AcceptedAnswerId int,\n    AnswerCount int,\n    ClosedDate DATE,\n    CommentCount int,\n    CommunityOwnedDate DATE,\n    CreationDate DATE,\n    FavoriteCount int,\n    LastActivityDate DATE,\n    LastEditDate DATE,\n    LastEditorUserId int,\n    OwnerUserId int,\n    ParentId int,\n    PostTypeId int,\n    Score int,\n    Tags nvarchar(500),\n    ViewCount int\n)\n WITH (\n     LOCATION = '/master/data/m_sharedknow/m_posts/m_2008-01-01/m_posts_200801-00002.parquet',,\n     DATA_SOURCE = ExternalUPDataSource,  \n     FILE_FORMAT = UPParquetFileFormat\n )\nGO\n-----------------------------------------------\n--Paso 03 -- Validación\n-----------------------------------------------\nSELECT TOP(100) * FROM master_transaction.dim_business_posts1_3\n-----------------------------------------------\n--Paso 04\n-----------------------------------------------\nCREATE EXTERNAL TABLE business_knowa.bi_posts2\nWITH (\n    LOCATION = '/business/b_sharedknow/b_posts/b_2008-01-01/',\n    DATA_SOURCE = ExternalUPDataSource,  \n    FILE_FORMAT = UPParquetFileFormat\n) AS \nSELECT * FROM master_transaction.dim_business_posts1_3;\n\nSELECT * FROM business_knowa.bi_posts2;\n\n-------------------------------------------------------------------------\n-- Carpeta Posts2\n-----------------------------------------------\n--Paso 01\n-----------------------------------------------\nSELECT TOP (10) *\nFrom OPENROWSET (BULK '/master/data/m_sharedknow/m_posts/m_2009-01-01/m_posts_200901-00002.parquet',\nDATA_SOURCE= 'ExternalUPDataSource',\nFORMAT ='PARQUET')  AS [file]\nGO;\n-----------------------------------------------\n--Paso 02\n-----------------------------------------------\nCREATE EXTERNAL TABLE master_transaction.dim_business_posts2_(\n    Id int,\n    AcceptedAnswerId int,\n    AnswerCount int,\n    ClosedDate DATE,\n    CommentCount int,\n    CommunityOwnedDate DATE,\n    CreationDate DATE,\n    FavoriteCount int,\n    LastActivityDate DATE,\n    LastEditDate DATE,\n    LastEditorUserId int,\n    OwnerUserId int,\n    ParentId int,\n    PostTypeId int,\n    Score int,\n    Tags nvarchar(500),\n    ViewCount int\n)\n WITH (\n     LOCATION = '/master/data/m_sharedknow/m_posts/m_2009-01-01/m_posts_200901-00002.parquet',\n     DATA_SOURCE = ExternalUPDataSource,  \n     FILE_FORMAT = UPParquetFileFormat\n )\nGO\n-----------------------------------------------\n--Paso 03 -- Validación\n-----------------------------------------------\nSELECT TOP(100) * FROM master_transaction.dim_business_posts2_\n-----------------------------------------------\n--Paso 04\n-----------------------------------------------\nCREATE EXTERNAL TABLE business_knowa.bi_posts2_1\nWITH (\n    LOCATION = '/business/b_sharedknow/b_posts/b_2009-01-01/',\n    DATA_SOURCE = ExternalUPDataSource,  \n    FILE_FORMAT = UPParquetFileFormat\n) AS \nSELECT * FROM master_transaction.dim_business_posts2_;\n\nSELECT * FROM business_knowa.bi_posts2_1\n\n-------------------------------------------------------------------------\n-- Carpeta Posttypes\n-----------------------------------------------\n--Paso 01\n-----------------------------------------------\nSELECT TOP (10) *\nFrom OPENROWSET (BULK '/master/data/m_sharedknow/m_posttypes/m_posttypes-00001.parquet',\nDATA_SOURCE= 'ExternalUPDataSource',\nFORMAT ='PARQUET')  AS [file]\nGO;\n-----------------------------------------------\n--Paso 02\n-----------------------------------------------\nCREATE EXTERNAL TABLE master_transaction.dim_business_posttypes(\n    Id int,\n    Type nvarchar(50)\n)\n WITH (\n     LOCATION = '/master/data/m_sharedknow/m_posttypes/m_posttypes-00001.parquet',\n     DATA_SOURCE = ExternalUPDataSource,  \n     FILE_FORMAT = UPParquetFileFormat\n )\nGO\n-----------------------------------------------\n--Paso 03 -- Validación\n-----------------------------------------------\nSELECT TOP(100) * FROM master_transaction.dim_business_posttypes\n-----------------------------------------------\n--Paso 04\n-----------------------------------------------\nCREATE EXTERNAL TABLE business_knowa.bi_posttypes\nWITH (\n    LOCATION = '/business/b_sharedknow/b_posttypes',\n    DATA_SOURCE = ExternalUPDataSource,  \n    FILE_FORMAT = UPParquetFileFormat\n) AS \nSELECT * FROM master_transaction.dim_business_posttypes;\n\nSELECT * FROM business_knowa.bi_posttypes;\n\n-------------------------------------------------------------------------\n-- Carpeta Users\n-----------------------------------------------\n--Paso 01\n-----------------------------------------------\nSELECT TOP (10) *\nFrom OPENROWSET (BULK '/master/data/m_sharedknow/m_users/m_users-00001.parquet',\nDATA_SOURCE= 'ExternalUPDataSource',\nFORMAT ='PARQUET')  AS [file]\nGO;\n-----------------------------------------------\n--Paso 02\n-----------------------------------------------\nCREATE EXTERNAL TABLE master_transaction.dim_business_users(\n    Id int,\n    CreationDate DATE,\n    DownVotes int,\n    LastAccessDate DATE,\n    Reputation int,\n    UpVotes int,\n    Views int,\n    AccountId int,\n    Email nvarchar(100)\n)\n WITH (\n     LOCATION = '/master/data/m_sharedknow/m_users/m_users-00001.parquet',\n     DATA_SOURCE = ExternalUPDataSource,  \n     FILE_FORMAT = UPParquetFileFormat\n )\nGO\n-----------------------------------------------\n--Paso 03 -- Validación\n-----------------------------------------------\nSELECT TOP(100) * FROM master_transaction.dim_business_users\n-----------------------------------------------\n--Paso 04\n-----------------------------------------------\nCREATE EXTERNAL TABLE business_knowa.bi_users\nWITH (\n    LOCATION = '/business/b_sharedknow/b_users',\n    DATA_SOURCE = ExternalUPDataSource,  \n    FILE_FORMAT = UPParquetFileFormat\n) AS \nSELECT * FROM master_transaction.dim_business_users;\n\nSELECT * FROM business_knowa.bi_users;\n\n-------------------------------------------------------------------------\n-- Carpeta Votes\n-----------------------------------------------\n--Paso 01\n-----------------------------------------------\nSELECT TOP (100) *\nFrom OPENROWSET (BULK '/master/data/m_sharedknow/m_votes/m_votes-00002.parquet',\nDATA_SOURCE= 'ExternalUPDataSource',\nFORMAT ='PARQUET')  AS [file]\nGO;\n-----------------------------------------------\n--Paso 02\n-----------------------------------------------\nCREATE EXTERNAL TABLE master_transaction.dim_business_votes(\n    Id int,\n    PostId int,\n    UserId int,\n    BountyAmount int,\n    VoteTypeId int,\n    CreationDate DATE\n)\n WITH (\n     LOCATION = '/master/data/m_sharedknow/m_votes/m_votes-00002.parquet',\n     DATA_SOURCE = ExternalUPDataSource,  \n     FILE_FORMAT = UPParquetFileFormat\n )\nGO\n-----------------------------------------------\n--Paso 03 -- Validación\n-----------------------------------------------\nSELECT TOP(100) * FROM master_transaction.dim_business_votes\n-----------------------------------------------\n--Paso 04\n-----------------------------------------------\nCREATE EXTERNAL TABLE business_knowa.bi_votes\nWITH (\n    LOCATION = '/business/b_sharedknow/b_votes',\n    DATA_SOURCE = ExternalUPDataSource,  \n    FILE_FORMAT = UPParquetFileFormat\n) AS \nSELECT * FROM master_transaction.dim_business_votes;\n\nSELECT * FROM business_knowa.bi_votes;\n\n-------------------------------------------------------------------------\n-- Carpeta Votetypes\n-----------------------------------------------\n--Paso 01\n-----------------------------------------------\nSELECT TOP (100) *\nFrom OPENROWSET (BULK '/master/data/m_sharedknow/m_votetypes/m_votetypes-00001.parquet',\nDATA_SOURCE= 'ExternalUPDataSource',\nFORMAT ='PARQUET')  AS [file]\nGO;\n-----------------------------------------------\n--Paso 02\n-----------------------------------------------\nCREATE EXTERNAL TABLE master_transaction.dim_business_votetypes(\n    Id int,\n    Name nvarchar(50)\n)\n WITH (\n     LOCATION = '/master/data/m_sharedknow/m_votetypes/m_votetypes-00001.parquet',\n     DATA_SOURCE = ExternalUPDataSource,  \n     FILE_FORMAT = UPParquetFileFormat\n )\nGO\n-----------------------------------------------\n--Paso 03 -- Validación\n-----------------------------------------------\nSELECT TOP(100) * FROM master_transaction.dim_business_votetypes\n-----------------------------------------------\n--Paso 04\n-----------------------------------------------\nCREATE EXTERNAL TABLE business_knowa.bi_votetypes\nWITH (\n    LOCATION = '/business/b_sharedknow/b_votetypes',\n    DATA_SOURCE = ExternalUPDataSource,  \n    FILE_FORMAT = UPParquetFileFormat\n) AS \nSELECT * FROM master_transaction.dim_business_votetypes;\n\nSELECT * FROM business_knowa.bi_votetypes;\n\n-----------------------------------------------\n--FINAL\n-----------------------------------------------\n\n\n",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "updatalakehouse_business",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/Create Table Sentence')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"content": {
					"query": "\nUSE updatalakehouse;\nGO\n\n-----------------------------------------------\n--Paso 01\n-----------------------------------------------\nSELECT TOP (10) *\nFrom OPENROWSET (BULK '/raw/data/sharedknow/users/*.parquet',\nDATA_SOURCE= 'ExternalUPDataSource',\nFORMAT ='PARQUET')  AS [file]\nGO;\n\n-----------------------------------------------\n--Paso 02\n-----------------------------------------------\nCREATE EXTERNAL TABLE master_party.dim_users100(\n    Id nvarchar(50),\n    CreationDate nvarchar(50),\n    DownVotes nvarchar(10),\n    LastAccessDate nvarchar(50),\n)\n WITH (\n     LOCATION = '/raw/data/sharedknow/users/',\n     DATA_SOURCE = ExternalUPDataSource,  \n     FILE_FORMAT = UPParquetFileFormat\n )\nGO\n\n-- Validación\nSELECT TOP(100) * FROM master_party.dim_users100;\n\n-----------------------------------------------\n--Paso 03\n-----------------------------------------------\nSELECT  Id CreationDate\nFROM master_party.dim_users1\n\n-----------------------------------------------\n--Paso 04\n-----------------------------------------------\nCREATE EXTERNAL TABLE business_knowa.bi_users_dim\nWITH (\n    LOCATION = '/business/business_knowa/bi_users_dim/',\n    DATA_SOURCE = ExternalUPDataSource,  \n    FILE_FORMAT = UPParquetFileFormat\n) AS \nSELECT TOP(100) Id, CreationDate FROM master_party.dim_users100;\n\nSELECT * FROM business_knowa.bi_users_dim;\n\n\nWITH ShortCreationTable(shortdate) AS (\nSELECT CONVERT(DATE, SUBSTRING(creation_date, 1,10)) AS shortdate\nFROM master_transaction.t_interaction\n), DistinctDateTable (distinctdate) AS (\nSELECT DISTINCT shortdate as distinctdate\nFROM ShortCreationTable\n)\nSELECT ROW_NUMBER() OVER(ORDER BY distinctdate ASC) AS period_id, \ndistinctdate as period,\nYEAR(distinctdate) as year,\nMONTH(distinctdate) as month\nFROM DistinctDateTable;\n\n-- Ultima clase\n\nCREATE EXTERNAL TABLE master_party.dim_users_delta(\n    Id nvarchar(50),\n    CreationDate nvarchar(50),\n    DownVotes nvarchar(10),\n    LastAccessDate nvarchar(50),\n    Reputation nvarchar(50),\n    UpVotes nvarchar(50),\n    Views nvarchar(50),\n    AccountId nvarchar(50),\n    Email nvarchar(50)\n)\n WITH (\n     LOCATION = '/raw/data/sharedknow/users/',\n     DATA_SOURCE = ExternalUPDataSource,  \n     FILE_FORMAT = UPParquetFileFormat\n )\nGO\n\n-- Validación\nSELECT TOP(100) * FROM master_party.dim_users_delta;\n\n\nCREATE EXTERNAL TABLE business_knowa.bi_users_delta\nWITH (\n    LOCATION = '/business/business_knowa/bi_users_delta/',\n    DATA_SOURCE = ExternalUPDataSource,  \n    FILE_FORMAT = UPParquetFileFormat\n) AS \nSELECT TOP(100) * FROM master_party.dim_users_delta;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "updatalakehouse",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/Initial_Script')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"content": {
					"query": "/*---------------------------------------------\nScript Inicial de UP Lakehouse\n-----------------------------------------------\nAutor: Mauro A. León Payano\nFecha: 24/05/2024*/\n-----------------------------------------------\n--Paso 1: Creacion de repositorio de datos\n-----------------------------------------------\nCREATE DATABASE updatalakehouse;\nGO\n\nUSE updatalakehouse;\nGO\n\n-----------------------------------------------\n--Paso 2: Creacion de dataset por zona de datos\n-----------------------------------------------\nCREATE SCHEMA master_transaction AUTHORIZATION dbo;\nGO\n\nCREATE SCHEMA master_channel AUTHORIZATION dbo;\nGO\n\nCREATE SCHEMA master_party AUTHORIZATION dbo;\nGO\n\nCREATE SCHEMA business_knowa AUTHORIZATION dbo;\nGO\n\n-------------------------------------------------------------------------\n--Paso 3: Asignación de clave de encriptación y formato de tablas externas\n-------------------------------------------------------------------------\nCREATE MASTER KEY ENCRYPTION BY PASSWORD = 'p39248J#asdasdiu89yuj1k29sdd'\nGO\n\nCREATE DATABASE SCOPED CREDENTIAL UPUserIdentity WITH IDENTITY = 'SHARED ACCESS SIGNATURE',\nSECRET = '?sv=2021-12-02&ss=bfqt&srt=sco&sp=rwdlacupyx&se=2023-06-30T10:47:11Z&st=2023-04-30T02:47:11Z&spr=https&sig=ezJCBxXXS9BCWwv3OA4CRL7y7BVfumdfdnE0VrqPlGE%3D'\nGO\n\nCREATE EXTERNAL DATA SOURCE ExternalUPDataSource\nWITH (\n    LOCATION = 'https://dlsupdskuafdevi5l.dfs.core.windows.net/',\n    CREDENTIAL = UPUserIdentity\n);\nGO\n\nCREATE EXTERNAL FILE FORMAT UPParquetFileFormat \nWITH (\n    FORMAT_TYPE = PARQUET,\n    DATA_COMPRESSION = 'org.apache.hadoop.io.compress.SnappyCodec'\n);\nGO\n\nCREATE EXTERNAL FILE FORMAT UPDeltaFileFormat\nWITH (\n    FORMAT_TYPE = DELTA\n);\nGO\n\nCREATE EXTERNAL FILE FORMAT UPCSVWithHEADERFORMAT\nWITH (\n    FORMAT_TYPE = DELIMITEDTEXT,\n    FORMAT_OPTIONS (\n        PARSER_VERSION='2.0',\n        FIELD_TERMINATOR = '|',\n        STRING_DELIMITER = '\"',\n        FIRST_ROW = 2)\n);\nGO\n",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "updatalakehouse",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/Script_Final')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"content": {
					"query": "CREATE DATABASE updatalakehouse_trabajofinal;\nGO\n\nUSE updatalakehouse_trabajofinal;\nGO\n\n-----------------------------------------------\n--Paso 2: Creacion de dataset por zona de datos\n-----------------------------------------------\nCREATE SCHEMA master_transaction AUTHORIZATION dbo;\nGO\n\nCREATE SCHEMA business_knowa AUTHORIZATION dbo;\nGO\n\n-------------------------------------------------------------------------\n--Paso 3: Asignación de clave de encriptación y formato de tablas externas\n-------------------------------------------------------------------------\nCREATE MASTER KEY ENCRYPTION BY PASSWORD = 'p39248J#asdasdiu89yuj1k29sdd'\nGO\n\nCREATE DATABASE SCOPED CREDENTIAL UPUserIdentity WITH IDENTITY = 'SHARED ACCESS SIGNATURE',\nSECRET = '?sv=2021-12-02&ss=bfqt&srt=sco&sp=rwdlacupyx&se=2023-06-10T06:19:50Z&st=2023-05-01T22:19:50Z&spr=https&sig=WbRvttB1FZ7bNe8yMqwkkPTpICG6tarHomtvDTaqQX0%3D'\nGO\n\nCREATE EXTERNAL DATA SOURCE ExternalUPDataSource\nWITH (\n    LOCATION = 'https://dlsupdskuafdevi5l.dfs.core.windows.net/',\n    CREDENTIAL = UPUserIdentity\n);\nGO\n\nCREATE EXTERNAL FILE FORMAT UPParquetFileFormat \nWITH (\n    FORMAT_TYPE = PARQUET,\n    DATA_COMPRESSION = 'org.apache.hadoop.io.compress.SnappyCodec'\n);\nGO\n\n-------------------------------------------------------------------------\n--Paso 4: Copia de Master a Business\n-------------------------------------------------------------------------\n\n-------------------------------------------------------------------------\n-- Geologia\n-----------------------------------------------\n--Paso 01\n-----------------------------------------------\nSELECT TOP (10) *\nFrom OPENROWSET (BULK '/master/trabajofinal/m_geologia1.parquet',\nDATA_SOURCE= 'ExternalUPDataSource',\nFORMAT ='PARQUET')  AS [file]\nGO;\n-----------------------------------------------\n--Paso 02\n-----------------------------------------------\nCREATE EXTERNAL TABLE master_transaction.dim_geologia(\n    Estimacion nvarchar(200),\n    Estatus nvarchar(200),\n    Nombre_de_Estructura nvarchar(200),\n    Full_Year_Budget float,\n    Budget_YTD_April float,\n    Actual_YTD_April float,\n    Detalle nvarchar(200),\n    Observacion nvarchar(200),\n    ActualVSFullYearBudget float,\n    ActualVSBudgetApril float\n)\n WITH (\n     LOCATION = '/master/trabajofinal/m_geologia1.parquet',\n     DATA_SOURCE = ExternalUPDataSource,\n     FILE_FORMAT = UPParquetFileFormat\n )\nGO\n-----------------------------------------------\n--Paso 03 -- Validación\n-----------------------------------------------\nSELECT TOP(100) * FROM master_transaction.dim_geologia\n-----------------------------------------------\n--Paso 04\n-----------------------------------------------\nCREATE EXTERNAL TABLE business_knowa.bi_geologia\nWITH (\n    LOCATION = '/business/trabajofinal/geologia/',\n    DATA_SOURCE = ExternalUPDataSource,  \n    FILE_FORMAT = UPParquetFileFormat\n) AS \nSELECT * FROM master_transaction.dim_geologia;\n\nSELECT * FROM business_knowa.bi_geologia;\n\n-------------------------------------------------------------------------\n-- Geomecanica\n-----------------------------------------------\n--Paso 01\n-----------------------------------------------\nSELECT TOP (10) *\nFrom OPENROWSET (BULK '/master/trabajofinal/m_geomecanica1.parquet',\nDATA_SOURCE= 'ExternalUPDataSource',\nFORMAT ='PARQUET')  AS [file]\nGO;\n-----------------------------------------------\n--Paso 02\n-----------------------------------------------\nCREATE EXTERNAL TABLE master_transaction.dim_geomecanica(\n    Estimacion nvarchar(200),\n    Estatus nvarchar(200),\n    Nombre_de_Estructura nvarchar(200),\n    Full_Year_Budget float,\n    Budget_YTD_April float,\n    Actual_YTD_April float,\n    Detalle nvarchar(200),\n    Observacion nvarchar(200),\n    ActualVSFullYearBudget float,\n    ActualVSBudgetApril float\n)\n WITH (\n     LOCATION = '/master/trabajofinal/m_geomecanica1.parquet',\n     DATA_SOURCE = ExternalUPDataSource,\n     FILE_FORMAT = UPParquetFileFormat\n )\nGO\n-----------------------------------------------\n--Paso 03 -- Validación\n-----------------------------------------------\nSELECT TOP(100) * FROM master_transaction.dim_geomecanica\n-----------------------------------------------\n--Paso 04\n-----------------------------------------------\nCREATE EXTERNAL TABLE business_knowa.bi_geomecanica\nWITH (\n    LOCATION = '/business/trabajofinal/geomecanica/',\n    DATA_SOURCE = ExternalUPDataSource,  \n    FILE_FORMAT = UPParquetFileFormat\n) AS \nSELECT * FROM master_transaction.dim_geomecanica;\n\nSELECT * FROM business_knowa.bi_geomecanica;\n\n-------------------------------------------------------------------------\n-- Oportunidades\n-----------------------------------------------\n--Paso 01\n-----------------------------------------------\nSELECT TOP (10) *\nFrom OPENROWSET (BULK '/master/trabajofinal/m_oportunidades1.parquet',\nDATA_SOURCE= 'ExternalUPDataSource',\nFORMAT ='PARQUET')  AS [file]\nGO;\n-----------------------------------------------\n--Paso 02\n-----------------------------------------------\nCREATE EXTERNAL TABLE master_transaction.dim_oportunidades(\n    Estimacion nvarchar(200),\n    Estatus nvarchar(200),\n    Nombre_de_Estructura nvarchar(200),\n    Full_Year_Budget float,\n    Budget_YTD_April float,\n    Actual_YTD_April float,\n    Detalle nvarchar(200),\n    Observacion nvarchar(200),\n    ActualVSFullYearBudget float,\n    ActualVSBudgetApril float\n)\n WITH (\n     LOCATION = '/master/trabajofinal/m_oportunidades1.parquet',\n     DATA_SOURCE = ExternalUPDataSource,\n     FILE_FORMAT = UPParquetFileFormat\n )\nGO\n-----------------------------------------------\n--Paso 03 -- Validación\n-----------------------------------------------\nSELECT TOP(100) * FROM master_transaction.dim_oportunidades\n-----------------------------------------------\n--Paso 04\n-----------------------------------------------\nCREATE EXTERNAL TABLE business_knowa.bi_oportunidades\nWITH (\n    LOCATION = '/business/trabajofinal/oportunidades/',\n    DATA_SOURCE = ExternalUPDataSource,  \n    FILE_FORMAT = UPParquetFileFormat\n) AS \nSELECT * FROM master_transaction.dim_oportunidades;\n\nSELECT * FROM business_knowa.bi_oportunidades;\n\n-------------------------------------------------------------------------\n-- Planeamiento\n-----------------------------------------------\n--Paso 01\n-----------------------------------------------\nSELECT TOP (10) *\nFrom OPENROWSET (BULK '/master/trabajofinal/m_planeamiento1.parquet',\nDATA_SOURCE= 'ExternalUPDataSource',\nFORMAT ='PARQUET')  AS [file]\nGO;\n-----------------------------------------------\n--Paso 02\n-----------------------------------------------\nCREATE EXTERNAL TABLE master_transaction.dim_planeamiento(\n    Estimacion nvarchar(200),\n    Estatus nvarchar(200),\n    Nombre_de_Estructura nvarchar(200),\n    Full_Year_Budget float,\n    Budget_YTD_April float,\n    Actual_YTD_April float,\n    Detalle nvarchar(200),\n    Observacion nvarchar(200),\n    ActualVSFullYearBudget float,\n    ActualVSBudgetApril float\n)\n WITH (\n     LOCATION = '/master/trabajofinal/m_planeamiento1.parquet',\n     DATA_SOURCE = ExternalUPDataSource,\n     FILE_FORMAT = UPParquetFileFormat\n )\nGO\n-----------------------------------------------\n--Paso 03 -- Validación\n-----------------------------------------------\nSELECT TOP(100) * FROM master_transaction.dim_planeamiento\n-----------------------------------------------\n--Paso 04\n-----------------------------------------------\nCREATE EXTERNAL TABLE business_knowa.bi_planeamiento\nWITH (\n    LOCATION = '/business/trabajofinal/planeamiento/',\n    DATA_SOURCE = ExternalUPDataSource,  \n    FILE_FORMAT = UPParquetFileFormat\n) AS \nSELECT * FROM master_transaction.dim_planeamiento;\n\nSELECT * FROM business_knowa.bi_planeamiento;\n\n-------------------------------------------------------------------------\n-- Retrasos_Operativos\n-----------------------------------------------\n--Paso 01\n-----------------------------------------------\nSELECT TOP (10) *\nFrom OPENROWSET (BULK '/master/trabajofinal/m_retrasos_operativos1.parquet',\nDATA_SOURCE= 'ExternalUPDataSource',\nFORMAT ='PARQUET')  AS [file]\nGO;\n-----------------------------------------------\n--Paso 02\n-----------------------------------------------\nCREATE EXTERNAL TABLE master_transaction.dim_retrasos_operativos(\n    Estimacion nvarchar(200),\n    Estatus nvarchar(200),\n    Nombre_de_Estructura nvarchar(200),\n    Full_Year_Budget float,\n    Budget_YTD_April float,\n    Actual_YTD_April float,\n    Detalle nvarchar(200),\n    Observacion nvarchar(200),\n    ActualVSFullYearBudget float,\n    ActualVSBudgetApril float\n)\n WITH (\n     LOCATION = '/master/trabajofinal/m_retrasos_operativos1.parquet',\n     DATA_SOURCE = ExternalUPDataSource,\n     FILE_FORMAT = UPParquetFileFormat\n )\nGO\n-----------------------------------------------\n--Paso 03 -- Validación\n-----------------------------------------------\nSELECT TOP(100) * FROM master_transaction.dim_retrasos_operativos\n-----------------------------------------------\n--Paso 04\n-----------------------------------------------\nCREATE EXTERNAL TABLE business_knowa.bi_retrasos_operativos\nWITH (\n    LOCATION = '/business/trabajofinal/retrasos_operativos/',\n    DATA_SOURCE = ExternalUPDataSource,  \n    FILE_FORMAT = UPParquetFileFormat\n) AS \nSELECT * FROM master_transaction.dim_retrasos_operativos;\n\nSELECT * FROM business_knowa.bi_retrasos_operativos;",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "updatalakehouse_trabajofinal",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		}
	]
}